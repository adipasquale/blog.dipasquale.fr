<!DOCTYPE html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Build and deploy huge static websites with Caddy &#8211; Adrien Di Pasquale Blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Mostly blogging about web development and Open Data">
    <meta name="robots" content="all">
    <meta name="author" content="Adrien Di Pasquale">
    
    <meta name="keywords" content="en">
    <link rel="canonical" href="https://blog.dipasquale.fr/en/2018/12/27/build-and-deploy-huge-static-websites-with-caddy/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Adrien Di Pasquale Blog" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202110041030" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Build and deploy huge static websites with Caddy">
    <meta property="og:description" content="Mostly blogging about web development and Open Data">
    <meta property="og:url" content="https://blog.dipasquale.fr/en/2018/12/27/build-and-deploy-huge-static-websites-with-caddy/">
    <meta property="og:site_name" content="Adrien Di Pasquale Blog">
    
    <meta property="og:image" content="https://blog.dipasquale.fr/images/me.jpeg">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@hypertextadrien" />
        <meta name="twitter:creator" content="@hypertextadrien" />
    
    <meta name="twitter:title" content="Build and deploy huge static websites with Caddy" />
    <meta name="twitter:description" content="Mostly blogging about web development and Open Data" />
    <meta name="twitter:url" content="https://blog.dipasquale.fr/en/2018/12/27/build-and-deploy-huge-static-websites-with-caddy/" />
    
    <meta name="twitter:image" content="https://blog.dipasquale.fr/images/me.jpeg" />
    

</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://blog.dipasquale.fr" class="site-title">Adrien Di Pasquale Blog</a>
      <nav class="site-nav">
        <a href="https://www.dipasquale.fr">About</a>
        



    
    
    
    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/adipasquale"></a>
    
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/hypertextadrien"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:adrien@dipasquale.fr"></a>
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/adriendipasquale"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Build and deploy huge static websites with Caddy</h1>
  <span class="post-meta">Dec 27, 2018</span><br>
  
  <span class="post-meta small">
  
    8 minute read
  
  </span>
</div>

<article class="post-content">
  <p>I will show you how to setup the hosting and deployment of a static website with thousands of pages dynamically built. It uses the <a href="https://caddyserver.com/">Caddy web server</a> and a <a href="https://digitalocean.com/">Digital Ocean</a>’s droplet - but it would work with any Ubuntu server.</p>

<h1 id="introduction">Introduction</h1>

<h2 id="first-of-all-dont-do-it">First of all, don’t do it!</h2>

<p>There are very few cases where it makes sense to use such a setup.
<a href="https://www.netlify.com/">Netlify</a>, among others, is a great hosting provider for static websites.
It is way simpler to setup, it can run custom build scripts, it gives you HTTPS out of the box, and CDN delivery.
All that for free!
So really, try building your website there first.</p>

<p>In some cases though, you may reach Netlify’s limits.
I personally experienced failures on Netlify upon deploying a website with 20k+ pages.
Even though the build part takes 2 minutes or so, deploys would hang on the upload step.</p>

<h2 id="why-not-host-it-on-s3-">Why not host it on S3 ?</h2>

<p>The next reasonable option would be to host the static website on S3.
It’s a pretty common setup too and is well documented by AWS.</p>

<p>Because builds should be automated, I tried setting up an AWS Lambda function that runs the build and uploads the files to S3.
After 2 days of headaches fighting with the AWS docs to understand how to make it work, I managed to finally run it.
Only to find out that the upload process from the AWS Lambda local storage to S3 is not fast enough.</p>

<p>I tried parallelizing the uploads using threads, but it was still too slow.
I managed to get to about 500 pages/minute but the Lambdas have a maximum timeout of 15 minutes so it’s not enough.
In any cases, a build that takes more than 15 minutes would not have been satisfying.</p>

<p>I’m not an AWS expert, but the whole process was so frustrating that I decided to go old-school and host it on a server I control.</p>

<h1 id="server-setup">Server setup</h1>

<p>I chose to use <a href="https://www.digitalocean.com/">Digital Ocean (aka DO)</a> for hosting my server, but most of these instructions would be applicable to any other provider (<a href="https://www.scaleway.com//">Scaleway</a>, <a href="https://www.vultr.com/">Vultr</a>, <a href="https://www.exoscale.com">Exoscale</a> …).</p>

<p>DO has a great blog about <a href="https://blog.digitalocean.com/deploying-a-fully-automated-git-based-static-website-in-under-5-minutes/">Deploying a Fully-automated Git-based Static Website in Under 5 Minutes</a> which helped me a lot.
I have condensed the instructions into a shell script: <a href="https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670">https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670</a>.
If you’re not familiar with this kind of setup, I suggest you follow the blog post instead of running the script.</p>

<p>In order to run the script, SSH into the newly created server and:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="nt">-O</span> - https://gist.github.com/adipasquale/05e432157fcba07b0d2a8cbfdf326670/raw | sh
</code></pre></div></div>

<p>Here is a quick summary of this script:</p>
<ul>
  <li>It installs the Caddy server</li>
  <li>It creates a systemd service</li>
  <li>It sets up Caddy to listen to a subdomain of nip.io</li>
  <li>Caddy will use Let’s Encrypt to get you a valid SSL certificate so that HTTPS works out-of-the-box.</li>
  <li>It uses the Caddy git plugin to automatically stay in sync with this repo: <a href="https://github.com/kamaln7/basic-static-website">kamaln7/basic-static-website</a></li>
</ul>

<p>The last output should point you to an URL that looks like https://YOUR_SERVER_IP.nip.io:</p>

<p><img src="/images/basic-static-website.png" alt="basic static website" /></p>

<p><em>(notice the green lock :)</em></p>

<p>In case it does not work properly, you can run this command on the server to see logs and exceptions from Caddy:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -f /var/log/syslog
</code></pre></div></div>

<p><strong>Important Note</strong>: We are skipping a lot of important steps for an actual production server here:</p>
<ul>
  <li>You should follow <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04">this DO guide</a> for securing your Ubuntu droplet</li>
  <li>You should create a DO Firewall <a href="https://cloud.digitalocean.com/networking/firewalls">here</a> and allow SSH, HTTP, and HTTPS inbound traffic</li>
  <li>If you own a domain name, you can add an DNS record of the A type that points to your droplet’s IP, or follow <a href="https://www.digitalocean.com/docs/networking/dns/how-to/add-domains/">this short guide</a> to use DO’s own name servers. Here, we are using nip.io to have a subdomain without any setup.</li>
</ul>

<h1 id="dynamic-build-system">Dynamic build system</h1>

<p>Currently, the server is synchronizing with a very simple static website project, that has no build script at all.</p>

<p>We will now switch to a dynamic build system.
The build script will create HTML pages from external data and template files, and the server will now serve the resulting files.
This build script will be re-executed upon each git push to the repository.</p>

<p>For the purpose of this article, I have created a very simple static website builder: <a href="https://github.com/adipasquale/giantsite">giantsite</a>.
It’s a 50-lines Python 3 script, that queries a <a href="https://jsonplaceholder.typicode.com/">dummy API</a> for 5000 photos, builds an HTML page for each and an index page that links to them.</p>

<p>First, fork <a href="https://github.com/adipasquale/giantsite">giantsite</a>.</p>

<p>Now let’s update Caddy’s configuration.
SSH into the server and update it with <code class="language-plaintext highlighter-rouge">vim /etc/caddy/Caddyfile</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /etc/caddy/Caddyfile

https://YOUR_SERVER_IP.nip.io {
    [...]
    git https://github.com/YOUR_GITHUB_HANDLE/giantsite /var/code/giantsite {
        interval 300
        then python3 /var/code/giantsite/build.py /var/www
    }
    root /var/www
}
</code></pre></div></div>

<p><em>(don’t forget to replace the CAPITAL_PARTS with your infos)</em></p>

<p>Here is what we have changed:</p>
<ul>
  <li>We have switched the GitHub repository from the static one to the dynamically built one that you just forked.</li>
  <li>We have also specified where the local repository should be stored: <code class="language-plaintext highlighter-rouge">/var/code/giantsite</code></li>
  <li>We have added a call to the <code class="language-plaintext highlighter-rouge">build.py</code> script from the fetched repo in the <code class="language-plaintext highlighter-rouge">then</code> option.
It will be ran upon each new pull.</li>
  <li>Finally, we have declared that the server’s root is <code class="language-plaintext highlighter-rouge">/var/www</code>.
It defines the files that will be served.</li>
</ul>

<p>We still have to perform a few steps in order for this setup to work.
Again, ssh into the server and run these commands</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install python3 (it's already installed on DO's droplets)</span>
apt <span class="nb">install </span>python3

<span class="c"># Create the new folders and set correct permissions</span>
<span class="nb">mkdir</span> /var/code/
<span class="nb">mkdir</span> /var/www/
<span class="nb">chown </span>www-data:www-data /var/code/
<span class="nb">chown </span>www-data:www-data /var/www/

<span class="c"># Restart Caddy, this will trigger a re-build</span>
systemctl restart caddy
</code></pre></div></div>

<p><em>Note : You may have to use <code class="language-plaintext highlighter-rouge">sudo</code> here if you’re not logged in as root</em></p>

<p>You should now be able to access your website and see the newly built website :</p>

<p><img src="/images/giantsite-screencast.gif" alt="giantsite screencast" /></p>

<h2 id="auto-deploys-on-push">Auto-deploys on push</h2>

<p>Currently, our Caddy server will synchronize with the GitHub repository every 300 seconds or so.
Let’s setup a Webhook from GitHub to our server, so that it synchronizes and rebuilds upon each push.</p>

<p>First, open a terminal and copy the output from <code class="language-plaintext highlighter-rouge">uuidgen</code>.
We’ll use this random string as a shared secret in our Webhook.</p>

<p>Now let’s setup Caddy so it listens to the Webhook.
SSH into the server, and run <code class="language-plaintext highlighter-rouge">vim /etc/caddy/Caddyfile</code> :</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/caddy/Caddyfile</span>

https://YOUR_SERVER_IP.nip.io <span class="o">{</span>
    <span class="o">[</span>...]
    git <span class="o">[</span>...] <span class="o">{</span>
        <span class="o">[</span>...]
        hook /github_hook YOUR_WEBHOOK_SECRET
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>and again, restart Caddy with :</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart caddy
</code></pre></div></div>

<p>The last step is to go to your forked GitHub repository’s Settings, and click “Add Webhook” in the Webhooks tab. Use <code class="language-plaintext highlighter-rouge">https://YOUR_SERVER_IP.nip.io/github_webhook</code> for the url. I suggest using a JSON Webhook, I’ve had issues with the regular ones</p>

<p><img src="/images/github-webhook.png" alt="Create a GitHub Webhook" />.</p>

<p>You can now try making a small change to the <code class="language-plaintext highlighter-rouge">build.py</code> script and pushing it.
Your Caddy server should pick it up within a few seconds, and rebuild the pages accordingly.</p>

<h1 id="bonus-api-to-manually-trigger-re-builds">Bonus: API to manually trigger re-builds</h1>

<p>If your external data is updated, you may want to trigger a build even though the code has not changed.
It can therefore be useful to have another Webhook that triggers rebuilds and is not linked to GitHub.</p>

<p>Let’s setup a small server that listens to GET requests on <code class="language-plaintext highlighter-rouge">/admin/rebuild</code> and triggers builds.
I’m using <a href="https://bottlepy.org/docs/dev/">bottle</a> here, as it’s the simplest one I can think of, but feel free to use any framework you like.</p>

<p>Create a new <code class="language-plaintext highlighter-rouge">server.py</code> file at the root of your forked repository :</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># server.py
</span>
<span class="kn">from</span> <span class="nn">build</span> <span class="kn">import</span> <span class="n">Builder</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>


<span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/admin/rebuild'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rebuild</span><span class="p">():</span>
    <span class="n">Builder</span><span class="p">(</span><span class="s">"/var/www"</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">'Rebuild done !'</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Commit it and push it so that your server picks it up.</p>

<p>Now, SSH into your server and install bottle:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update
apt <span class="nb">install</span> <span class="nt">-y</span> python3-pip
pip3 <span class="nb">install </span>bottle
</code></pre></div></div>

<p>You need to create another systemd service for this bottle server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/systemd/system/bottle.service</span>

<span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Bottle server
<span class="nv">After</span><span class="o">=</span>syslog.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">User</span><span class="o">=</span>www-data
<span class="nv">Group</span><span class="o">=</span>www-data
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/code/giantsite
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/env python3 server.py
<span class="nv">StandardOutput</span><span class="o">=</span>syslog
<span class="nv">StandardError</span><span class="o">=</span>syslog
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>2

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>bottle.target
</code></pre></div></div>

<p>This new service can be started with:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start bottle
systemctl <span class="nb">enable </span>bottle
</code></pre></div></div>

<p>And we also have to update the Caddyfile so that external requests are directed to this bottle server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/caddy/Caddyfile</span>

https://YOUR_SERVER_IP.nip.io <span class="o">{</span>
    <span class="o">[</span>...]
    proxy /admin localhost:8000 <span class="o">{</span>
        transparent
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><em>Note: I used a namespaced route <code class="language-plaintext highlighter-rouge">/admin</code> here but you’re free to do as you please. Be careful that it matches what bottle expects though.</em></p>

<p>Finally, restart Caddy so that the changes are applied:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart caddy
</code></pre></div></div>

<p>Phew! You should now be able to trigger a rebuild with a simple:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://YOUR_SERVER_IP.nip.io/admin/rebuild
</code></pre></div></div>

<p>🛠 Build, Build, Build 🛠</p>

<h1 id="conclusion">Conclusion</h1>

<p>This setup makes sense only in rare situations, namely when you are building thousands of files.
It’s an interesting experience though, as it shows how easy and convenient Caddy makes it.
The <a href="https://caddyserver.com/docs/http.git">git plugin</a> is particularly cool, it’s so nice to be able to deploy with a simple <code class="language-plaintext highlighter-rouge">git push</code>.</p>

<p>This setup is not ready for production, make sure to add some security measures! The rebuild API is completely unprotected for instance.</p>

<p>Let me know what you think!</p>

<p><a href="https://news.ycombinator.com/item?id=18768691">Discuss on Hacker News</a></p>

</article>




  <div class="py2 post-footer">
  <img src="/images/me.jpeg" alt="Adrien Di Pasquale" class="avatar" />
  <p>
    👋 I'm Adrien Di Pasquale, a freelance web developer
    <br/>
    Follow me on Twitter : <a href="https://twitter.com/hypertextadrien">@hypertextadrien</a>
  </p>
</div>











      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Powered by <a href="https://jekyllrb.com/">Jekyll</a> with the <a href="https://github.com/johno/pixyll">Pyxill theme</a> and hosted on <a href="https://netlify.com">Netlify</a>
    </small>
  </div>
</footer>


</body>
</html>
